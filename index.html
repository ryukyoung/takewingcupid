<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Take Wing, CUPID!</title>

    <!-- iOS 풀스크린/안전영역 대응 -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <style>
      :root {
        color-scheme: dark;
      }

      /* 기본 스타일 (기존 유지) */
      body {
        margin: 0;
        background: #000;
      }
      canvas {
        display: block;
        margin: auto;
      }

      /* 폰트 (경로 혼용 대응: public/assets/..., src/... 둘 다 시도) */
      @font-face {
        font-family: "DOSMyunjo"; /* 권장 이름 */
        src: url("/assets/fonts/DOSMyunjo.ttf") format("truetype"),
          url("/src/fonts/DOSMyunjo.ttf") format("truetype");
        font-display: swap;
      }
      @font-face {
        font-family: "DOSMyungjo"; /* 오탈자 호환용 별칭 */
        src: url("/assets/fonts/DOSMyunjo.ttf") format("truetype"),
          url("/src/fonts/DOSMyunjo.ttf") format("truetype");
        font-display: swap;
      }
      @font-face {
        font-family: "DOSPilgi";
        src: url("/assets/fonts/DOSPilgi.ttf") format("truetype"),
          url("/src/fonts/DOSPilgi.ttf") format("truetype");
        font-display: swap;
      }

      /* ===== 전체화면 토글 버튼 ===== */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      .fs-btn {
        position: fixed;
        right: calc(env(safe-area-inset-right, 0px) + 12px);
        bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
        z-index: 9999;
        width: 46px;
        height: 46px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 14px;
        border: 1px solid #2a63ff;
        background: rgba(18, 18, 24, 0.7);
        color: #e9ecff;
        backdrop-filter: blur(6px);
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }
      .fs-btn:active {
        transform: translateY(1px);
      }
      .fs-btn .icon {
        width: 22px;
        height: 22px;
        display: block;
      }

      /* ==== 의사 풀스크린 fallback ==== */
      html.fs-fallback,
      body.fs-fallback {
        height: 100svh; /* 보이는 영역 기준 세이프 뷰포트 */
        overflow: hidden;
      }
      canvas.fs-fill {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100svh;
      }
    </style>
  </head>
  <body>
    <!-- 전체화면 토글 아이콘 버튼 -->
    <button
      id="fsToggle"
      class="fs-btn"
      type="button"
      aria-pressed="false"
      aria-label="전체화면 시작"
    >
      <span class="sr-only">전체화면 토글</span>

      <!-- Enter Fullscreen -->
      <svg id="iconEnter" class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <g
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M4 9V4h5" />
          <path d="M20 9V4h-5" />
          <path d="M4 15v5h5" />
          <path d="M20 15v5h-5" />
        </g>
      </svg>

      <!-- Exit Fullscreen -->
      <svg
        id="iconExit"
        class="icon"
        viewBox="0 0 24 24"
        aria-hidden="true"
        style="display: none"
      >
        <g
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M9 5H5v4" />
          <path d="M15 5h4v4" />
          <path d="M19 15v4h-4" />
          <path d="M5 15v4h4" />
          <path d="M5 5l5 5" />
          <path d="M19 5l-5 5" />
          <path d="M19 19l-5-5" />
          <path d="M5 19l5-5" />
        </g>
      </svg>
    </button>

    <!-- 너의 게임 엔트리 스크립트 -->
    <script type="module" src="/src/main.js"></script>

    <!-- 전체화면 토글 스크립트 (사파리 대응 + fallback) -->
    <script>
      const btn = document.getElementById("fsToggle");
      const iconEnter = document.getElementById("iconEnter");
      const iconExit = document.getElementById("iconExit");

      // ===== Fallback(의사 풀스크린) 적용/해제 =====
      function fallbackOn() {
        document.documentElement.classList.add("fs-fallback");
        document.body.classList.add("fs-fallback");
        const canvas = document.querySelector("canvas");
        if (canvas) canvas.classList.add("fs-fill");
        syncBtn();
      }
      function fallbackOff() {
        document.documentElement.classList.remove("fs-fallback");
        document.body.classList.remove("fs-fallback");
        const canvas = document.querySelector("canvas");
        if (canvas) canvas.classList.remove("fs-fill");
        syncBtn();
      }
      function isFallbackOn() {
        return document.documentElement.classList.contains("fs-fallback");
      }

      function inFs() {
        return (
          !!(document.fullscreenElement || document.webkitFullscreenElement) ||
          isFallbackOn()
        );
      }

      async function enterFs() {
        // iOS 사파리는 캔버스에 직접 요청하는 게 더 잘 먹힘
        const canvas = document.querySelector("canvas");
        const el = canvas || document.documentElement;

        try {
          if (el.requestFullscreen) {
            await el.requestFullscreen({ navigationUI: "hide" });
            return;
          } else if (el.webkitRequestFullscreen) {
            // webkit prefixed는 옵션 없이 호출
            await el.webkitRequestFullscreen();
            return;
          }
          // 지원 안 하면 fallback
          fallbackOn();
        } catch (e) {
          // 거부/예외 시 fallback
          fallbackOn();
        }
      }

      async function exitFs() {
        try {
          if (document.exitFullscreen) {
            await document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            await document.webkitExitFullscreen();
          }
        } catch (e) {
          /* noop */
        } finally {
          fallbackOff();
        }
      }

      function syncBtn() {
        const on = inFs();
        iconEnter.style.display = on ? "none" : "block";
        iconExit.style.display = on ? "block" : "none";
        btn.setAttribute("aria-pressed", String(on));
        btn.setAttribute(
          "aria-label",
          on ? "전체화면 나가기" : "전체화면 시작"
        );
      }

      btn.addEventListener("click", async () => {
        if (inFs()) await exitFs();
        else await enterFs();
      });

      document.addEventListener("fullscreenchange", syncBtn);
      document.addEventListener("webkitfullscreenchange", syncBtn);
      syncBtn();
    </script>
  </body>
</html>
